{% extends "layout.html" %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- Page Header -->
    <div class="text-center mb-4">
        <h2 class="fw-bold">ðŸ’° Financial Dashboard</h2>
        <p class="text-muted">Complete vehicle, driver, and indent financial overview</p>
    </div>

    <!-- Summary Cards per Vehicle -->
    <div class="row mb-4">
        {% for vehicle_id, stats in summary.items() %}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-header bg-primary text-white">
                    Vehicle ID: {{ vehicle_id }}
                </div>
                <div class="card-body">
                    <p><strong>Revenue:</strong> â‚¹{{ stats.revenue | round(2) }}</p>
                    <p><strong>Total Cost:</strong> â‚¹{{ stats.cost | round(2) }}</p>
                    <p><strong>Fuel Cost:</strong> â‚¹{{ stats.fuel_cost | round(2) }}</p>
                    <p><strong>PnL:</strong> â‚¹{{ stats.pnl | round(2) }}</p>
                    <p><strong>Orders:</strong> {{ stats.orders or 0 }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-3">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by Vehicle/Driver">
        </div>
        <div class="col-md-2">
            <button class="btn btn-success" id="exportBtn">Export CSV</button>
        </div>
    </div>

    <!-- Detailed Routes Table -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Trip & Vehicle Details</h5>
        </div>
        <div class="card-body table-responsive">
            <table id="financialTable" class="table table-striped table-bordered align-middle">
                <thead class="table-dark text-center">
                    <tr>
                        <th>Vehicle ID</th>
                        <th>Vehicle Model</th>
                        <th>Driver ID</th>
                        <th>Driver Name</th>
                        <th>Shift</th>
                        <th>Availability</th>
                        <th>Indent Date</th>
                        <th>Pickup</th>
                        <th>Drop</th>
                        <th>Total KM</th>
                        <th>Material</th>
                        <th>LR No.</th>
                        <th>Customer</th>
                        <th>Range</th>
                        <th>Product</th>
                        <th>No. Buckets</th>
                        <th>Load/Bucket</th>
                        <th>Total Load</th>
                        <th>Transport Rate</th>
                        <th>Loading Rate</th>
                        <th>Unloading Rate</th>
                        <th>Other Costs</th>
                        <th>Total Cost</th>
                        <th>Revenue</th>
                        <th>Fuel Cost</th>
                        <th>PnL</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trip in routes %}
                    <tr>
                        <td>{{ trip.vehicle_id }}</td>
                        <td>{{ trip.vehicle_model }}</td>
                        <td>{{ trip.driver_id }}</td>
                        <td>{{ trip.driver_name }}</td>
                        <td>{{ trip.shift_info }}</td>
                        <td>{{ trip.availability }}</td>
                        <td>{{ trip.indent_date }}</td>
                        <td>{{ trip.pickup_location }}</td>
                        <td>{{ trip.drop_location }}</td>
                        <td>{{ trip.total_km }}</td>
                        <td>{{ trip.material }}</td>
                        <td>{{ trip.lr_no }}</td>
                        <td>{{ trip.customer_name }}</td>
                        <td>{{ trip.indent_range }}</td>
                        <td>{{ trip.product }}</td>
                        <td>{{ trip.no_of_buckets }}</td>
                        <td>{{ trip.load_per_bucket }}</td>
                        <td>{{ trip.total_load }}</td>
                        <td>{{ trip.transport_rate }}</td>
                        <td>{{ trip.total_cost_loading }}</td>
                        <td>{{ trip.total_cost_unloading }}</td>
                        <td>{{ trip.any_other_cost }}</td>
                        <td>{{ trip.total_cost_final }}</td>
                        <td>{{ trip.revenue }}</td>
                        <td>{{ trip.fuel_cost }}</td>
                        <td>{{ trip.pnl }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- JS for search/filter and export -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('financialTable');
        const searchInput = document.getElementById('searchInput');
        const exportBtn = document.getElementById('exportBtn');

        // Simple Search Filter
        searchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            Array.from(table.tBodies[0].rows).forEach(row => {
                row.style.display = Array.from(row.cells).some(cell =>
                    cell.textContent.toLowerCase().includes(filter)
                ) ? '' : 'none';
            });
        });

        // CSV Export
        exportBtn.addEventListener('click', function() {
            let csv = [];
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                csv.push(Array.from(cols).map(c => `"${c.innerText}"`).join(','));
            });

            const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
            const downloadLink = document.createElement('a');
            downloadLink.download = 'financial_dashboard.csv';
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
        });
    });
</script>
{% endblock %}
